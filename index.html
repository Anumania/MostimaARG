

<script>
mosawake = false;
transparency = 0;
storypart = 0;
storychar = 0;
speed = 60;
flavor_text = 
["get this, he turns himself into a pickle",
"mostima looks like shes gonna win by any means necessary",
"mostima is among bitches (and you arent)",
"mostima is dripping (and you arent)",
"mostima is sus"
]
story = ["...",
"Youve made a horrible mistake, coming here.",
"We both know why youre here, and we both know you arent leaving until you get what you want",
"You arent gonna get it with me around, so maybe you should back up and try and get some bitches instead"
]
images = ["https://media.discordapp.net/attachments/623381118552375313/812210903566516224/MOSTIMA_DRIP_3.png?width=319&height=558", 
"https://media.discordapp.net/attachments/623381118552375313/812210895181709333/MOSTIMA_DRIP.png?width=319&height=558",
"https://media.discordapp.net/attachments/623381118552375313/812210813984833546/MOSTIMA_DRIP_2.png?width=319&height=558",
"https://media.discordapp.net/attachments/623381118552375313/812210920306376734/MOSTIMA_DRIP_SANS.png?width=319&height=558"]
count = 0;
img = 0;
inter = 0;
window.onload = function(){
	interv = setInterval(refresh, 1000/60);
	loadImages();
	
}

refresh = function(){
	count++;
	if(count%speed == 0 && mosawake == true){
		storychar++;
	}
	if(count>100 && !mosawake){
		transparency+=0.01;
		document.getElementById("mos").style.opacity=transparency;
		if(document.getElementById("mos").style.opacity > 1){
			mosawake = true;
		}
	}
	if(mosawake){
		document.getElementById("textbox").innerHTML = story[storypart].substring(0,storychar)

	}
	switch(storypart){
		 case 0: document.getElementById("mos").src = images[0]; break;
		 case 1: document.getElementById("mos").src = images[2]; speed = 5;  break;
		 case 2: document.getElementById("mos").src = images[0]; break;
		 case 2: document.getElementById("mos").src = images[1]; break;
		}
	if(storychar >= story[storypart].length && storypart == story.length-1){ //if the vn part is done, we go.
		time_for_game();
	}
}
ongo = function(b){
	if(mosawake && storychar >= story[storypart].length){
		if(story.length > storypart){
			storychar = 0;
			storypart++;
		}
	}
	if(b.code == "Digit9"){ //skip for debugging
		time_for_game();
	}
}
time_for_game = function(){//kill everything and get the canvas started.
	document.getElementById("mos").src = " ";
	document.getElementById("mos").style.opacity = 0;
	document.getElementById("textbox").innerHTML = "stop snooping wait for me to finish my shit before looking";
	document.getElementById("canvas").width = 800;
	document.getElementById("canvas").height = 400;
	window.onclick = function(){}
	clearInterval(interv);
	document.removeEventListener('keypress', ongo);
	gameCreate();
}
window.onclick = ongo;
document.addEventListener('keypress', ongo);



loadImages = function(){ //this lets the images load while the vn is happenin.
	sprites["soul"] = newImage("Red_SOUL_sprite.png");
	sprites["bullet"] = newImage("bullet.png")
}
newImage = function(str){
	var n = new Image();
	n.src = str;
	return n;
}
sprites = new Map();
loopTimer = 0;
canvas = 0;
game = 0;
gameObjects = [];
gameKeys = new Array(200);//every key and then some
function ord(str){return str.toLowerCase().charCodeAt(0);}
function chr(num){return String.fromCharCode(num);}
keydown = function(_key){
	gameKeys[ord(_key.key)] = true;
}
keyup = function(_key){
	gameKeys[ord(_key.key)] = false;
}
gameCreate = function(){
	document.body.style.backgroundColor = 0x000000
	canvas = document.getElementById("canvas");
	game = canvas.getContext("2d");
	loopTimer = setInterval(gameRefresh, 1000/60);
	canvas.style = "position:absolute; margin-top: 150px;left: 50%; width: 800px; margin-left: -400px";
	document.addEventListener('keydown', keydown);
	document.addEventListener('keyup', keyup);
	new BulletBoard(0,0);
	new Player(50,50);
	new FightManager(0,0);
	//new TextBox(400,300);
}

gameRefresh = function(){
	//event.keyCode
	game.fillStyle = "black"; //wipe screen.
	game.fillRect(0,0,800,600);
	for(var i = 0; i < gameObjects.length; i++){//step
		gameObjects[i].step();
	}
	for(var i = 0; i < gameObjects.length; i++){//draw
		gameObjects[i].draw();
	}
}
addToStepList = function(gameObject){
	gameObjects.push(gameObject);
}
removeFromStepList = function(_gameObject){
	for(var i = 0; i < gameObjects.length; i++){
		if(gameObjects[i] === _gameObject){
			gameObjects.splice(i,1);
			return;
		}
	}
}


class GameObject{
	x = 0;
	y = 0;
	width = 0;
	height = 0;
	sprite = 0;
	constructor(_x,_y){
		this.x = _x;
		this.y = _y;
		this.width = 16;
		this.height = 16;
		this.sprite = sprites["soul"];//this needs to be replaced or you will always be soul;
		addToStepList(this);
	}

	drawSelf(){
		game.drawImage(this.sprite,this.x,this.y,this.width,this.height);
	}
	//thanks https://stackoverflow.com/questions/3793397/html5-canvas-drawimage-with-at-an-angle
	rotateAndPaintImage = function( context, image, angleInRad , positionX, positionY, axisX, axisY ) {
		context.translate( positionX, positionY );
		context.rotate( angleInRad );
		context.drawImage( image, -axisX, -axisY );
		context.rotate( -angleInRad );
		context.translate( -positionX, -positionY );
	}
	draw = function(){return;};
	step = function(){return;};


}

class Player extends GameObject{
	speed = 3;
	bulletBoard = 0;
	state = 0;
	constructor(_x,_y){
		super(_x,_y);
		this.state = this.redMove;
		for(var j = 0; j < gameObjects.length; j++){
			if(gameObjects[j].__proto__.constructor == BulletBoard){
				this.bulletBoard = gameObjects[j];
			} 
		}
	}
	step = function(){
		this.state();
	}
	draw = function(){
		this.drawSelf();

	}

	redMove = function(){ //red heart from undytale
		if(gameKeys[ord("j")]){this.x-=this.speed};
		if(gameKeys[ord("i")]){this.y-=this.speed};
		if(gameKeys[ord("l")]){this.x+=this.speed};
		if(gameKeys[ord("k")]){this.y+=this.speed};
		if(gameKeys[ord("p")]){new MostimaSecondSkill(this.x,this.y)};

		this.x = Util.Clamp(this.x,this.bulletBoard.x+3, this.bulletBoard.x+this.bulletBoard.width-this.width-3);
		this.y = Util.Clamp(this.y,this.bulletBoard.y+3, this.bulletBoard.y+this.bulletBoard.height-this.height-3);
	}
	blueMove = function(){//blue heart from undytale

	}
	greenMove = function(){//green heart from undytale
		
	}
	UIMove = function(){//ui if i ever want ui

	}

}
class TextBox extends GameObject{
	targetw = 1000;//must be divisible by 20
	targeth = 200; //also must be divisible by 20
	constructor(_x,_y){
		super(_x,_y);
		this.width = 0;
		this.height =0;
		
	}
	step = function(){
		return;
	}
	draw = function(){
		game.fillStyle = "black";
		game.fillRect(this.x-(this.width/4),this.y-(this.height/4),this.width/2,this.height/2); 
		game.strokeStyle = "white";
		game.lineWidth = 4;
		game.strokeRect(this.x-(this.width/4),this.y-(this.height/4),this.width/2,this.height/2);
		if(this.width != this.targetw || this.height != this.targeth){
			this.width += Math.sign(this.targetw-this.width)*20;
			this.height += Math.sign(this.targeth-this.height)*20;
		}
		else{
			game.font = "17px elfont";
			game.fillStyle = "white"
			game.fillText("*  Mostima is dripping",this.x-this.width/4+10,this.y-this.height/4+30);
		}
		
	}
}
class BulletBoard extends GameObject{
	step = function(){
		this.x = 250;
		this.width = 300;
		this.y = 90;
		this.height = 300;
	}
	draw = function(){
		game.fillStyle = "black";
		game.fillRect(this.x,this.y,this.width,this.height); 
		game.strokeStyle = "white";
		game.lineWidth = 4;
		game.strokeRect(this.x,this.y,this.width,this.height);		
	}
}
class MostimaSecondSkill extends GameObject{ //its just a bunch of squares that progressively get smaller and rotated
	count = 0;
	rotation = 30;
	blink = 0
	constructor(_x,_y){
		super(_x,_y);
		this.width = 128;
		this.height = 128;
	}
	step = function(){
		if(Math.abs(this.count-60)<4){
			this.blink = 100;
		}
		else{
			this.blink = 0;
		}
		this.count++;
		this.rotation+=1;
		this.scaler+=Math.sin(this.count/10)/50;
	}
	scaler = 2;
	draw = function(){
		var loops = 5;
		var val = Math.max(this.blink + ((Math.sin(this.count/50))*100),20);
		game.strokeStyle = Util.MakeColor(val,val,val);

		game.translate(this.x,this.y);
		for(var i = 0; i < loops; i++){
			game.strokeRect(-this.width/2,-this.width/2,this.width,this.height);
			game.scale(1/this.scaler,1/this.scaler)
			game.rotate(this.rotation/Util.Rad2Deg);
		}
		for(var i = 0; i < loops; i++){ //undo 
			game.rotate(-this.rotation/Util.Rad2Deg);
			game.scale(this.scaler,this.scaler)
		}
		
		if(this.blink){
			var scaled = 1+(this.count-54)/10;
			game.scale(scaled,scaled)
			game.strokeRect(-this.width/2,-this.width/2,this.width,this.height);
			game.scale(1/scaled,1/scaled)
		}
		if(this.count > 65){
			removeFromStepList(this);
			for(var j = 0; j < gameObjects.length; j++){
				if(gameObjects[j].__proto__.constructor == Bullet){
					var bullet = gameObjects[j];
					if(bullet.x>this.x-this.width/2&& //collision but fucked up
					bullet.x < this.x+this.width/2&&
					bullet.y>this.y-this.height/2&&
					bullet.y < this.y+this.height/2){
						bullet.speed = 0;
					}
				} 
			}	
		}
		game.translate(-this.x,-this.y);
	}
}
class MostimaThirdSkill extends GameObject{

}
class Bullet extends GameObject{
	dir = 0;
	speed = 0;
	targetSpeed = 0;
	constructor(_x,_y, _dir,_step = null){
		super(_x,_y)
		//this.step = _step;
		this.dir = _dir;
		if(_step != null){
			this.step = _step;
		}
		this.targetSpeed = 2;
		this.speed = 2;
		this.sprite = sprites["bullet"];
	}
	draw = function(){
		this.rotateAndPaintImage(game,this.sprite,this.dir/Util.Rad2Deg,this.x,this.y,this.width/2,this.height/2)
	}
	step = function(){
		this.x+=Math.cos(this.dir/Util.Rad2Deg)*this.speed;
		this.y+=Math.sin(this.dir/Util.Rad2Deg)*this.speed;

		if(this.y > 800){
			removeFromStepList(this);
		}
		this.speed = Util.lerp(this.speed,this.targetSpeed,0.01);
	}
}
class Hurtbox extends GameObject{


}
class FightManager extends GameObject{
	count = 0;
	phase = 0;
	
	constructor(_x,_y){
		super(_x,_y)
		this.count = 0;
	}
	step = function(){

		this.count++;
		this.phases[this.phase](this); //for some reason the array becomes its own scope?
	}
	phase1 = function(_this){
		if(_this.count < 160){
			new Bullet(400+(Math.cos(_this.count/20)*300),80,90);
		}
		if(_this.count%60 == 59){
			var pl = 0;
			for(var j = 0; j < gameObjects.length; j++){
				if(gameObjects[j].__proto__.constructor == Player){
					pl = gameObjects[j];
					break;
				} 
			}
			new MostimaSecondSkill(pl.x,pl.y);
		}
		if(_this.count > 240){
			_this.phase++;
		}
	}
	phase2 = function(_this){

	}
	phases = [this.phase1,this.phase2]
	
}
class Util{
	static Clamp(val,min,max){
		return Math.min(Math.max(val,min),max);
	} 
	static Rad2Deg = 57.2958;
	static MakeColor(red,green,blue){
		var str = "#"
		str+=Util.decimalToHex(red%256,2);
		str+=Util.decimalToHex(green%256,2);
		str+=Util.decimalToHex(blue%256,2);
		return str;
	}

	static decimalToHex(d, padding) {
		var hex = Number(Math.floor(d)).toString(16);
		padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;
		while (hex.length < padding) {
			hex = "0" + hex;
		}
		return hex;
	}
	static lerp(v0, v1, t) {
    	return v0*(1-t)+v1*t;
	}
}




//game time


</script>

<style>
@font-face {
font-family: 'elfont';
src: url('font1.ttf');
}
.center {
  display: block;
  margin-left: auto;
  word-break: keep-all;
  margin-right: auto;
  width: 20%;
  text-align: center;
 }
img {
  opacity: 0.0;
}
</style>
<canvas id="canvas" width="0" height="0" style="center"> </canvas>
<img src = "https://media.discordapp.net/attachments/623381118552375313/812210920306376734/MOSTIMA_DRIP_SANS.png?width=319&height=558" id="mos" class = "center"></img>
<p id = "textbox" class = "center"> </p>
</html>